<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detector de Voz IA</title>
  <style>
    * {
      box-sizing: border-box;
    }

    main {
      text-align: center;
      padding: 40px 20px;
    }

    main h1 {
      margin-bottom: 40px;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to bottom right, #1f1f1f, #333);
      color: #fff;
      margin: 0;
      padding-top: 80px;
      padding-bottom: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }

    header {
      position: fixed;
      top: 0;
      width: 100%;
      background-color: #121212;
      padding: 20px 0;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    header h2 {
      margin: 0;
      font-size: 1.5em;
      color: #00ccff;
    }

    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background-color: #121212;
      text-align: center;
      padding: 10px 20px;
      font-size: 0.9em;
      color: #aaa;
      border-top: 1px solid #333;
    }

    h1 {
      margin-bottom: 80px;
      font-size: 2em;
    }

    .drop-zone {
      border: 2px dashed #666;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      width: 90%;
      max-width: 500px;
      background-color: #2c2c2c;
      cursor: pointer;
      transition: border-color 0.3s ease;
      margin: 40px auto;
    }

    .drop-zone:hover {
      border-color: #00ccff;
    }

    input[type="file"] {
      display: none;
    }

    .progress-container {
      margin: 60px auto 40px auto;
      width: 100%;
      max-width: 500px;
    }

    .progress-bar {
      height: 20px;
      background-color: #00ccff;
      width: 0%;
      border-radius: 10px;
      transition: width 0.4s ease;
    }

    .result {
      margin-top: 50px;
      font-size: 1.2em;
      padding: 10px 20px;
      background-color: #444;
      border-radius: 10px;
    }

    /* Estilos para la lista de archivos */
    #lista-archivos {
      width: 90%;
      max-width: 800px;
      margin: 40px auto;
      background-color: #2c2c2c;
      border-radius: 10px;
      padding: 20px;
    }

    #lista-archivos h2 {
      margin-bottom: 20px;
      color: #00ccff;
    }

    #archivos-table {
      width: 100%;
      border-collapse: collapse;
    }

    #archivos-table th,
    #archivos-table td {
      padding: 10px;
      border: 1px solid #444;
      text-align: left;
      font-size: 0.9em;
    }

    #archivos-table th {
      background-color: #121212;
      color: #00ccff;
    }

    #archivos-table td a {
      color: #00ccff;
      text-decoration: none;
    }

    #archivos-table td a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>

  <header>
    <h2>Sistema de Detección de Voz IA</h2>
  </header>
|  <p>version: 0.1</p>
  <main>
    <h1>Sube tu archivo de audio</h1>
    <br><br><br>
    <label class="drop-zone" id="drop-zone">
      Arrastra tu archivo de audio aquí o haz clic para subir
      <input type="file" accept="audio/*" id="file-input" />
    </label>

    <div class="progress-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>

    <div class="result" id="result" style="display: none;"></div>

    <!-- Sección para mostrar la lista de archivos -->
    <div id="lista-archivos">
      <h2>Archivos Recientes</h2>
      <table id="archivos-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre de Archivo</th>
            <th>Fecha de Subida</th>
            <th>Enlace S3</th>
          </tr>
        </thead>
        <tbody id="archivos-tbody">
          <!-- Aquí se inyectarán las filas -->
        </tbody>
      </table>
    </div>
  </main>

  <footer>
    Proyecto Integrado de Ingeniería de Software<br>
    Grupo 4: Carlos Fuentes, Ricardo Medina, Genesis Piña y Marcelo Rozas
  </footer>

  <script>
    const dropZone    = document.getElementById('drop-zone');
    const fileInput   = document.getElementById('file-input');
    const progressBar = document.getElementById('progress-bar');
    const result      = document.getElementById('result');

    const UPLOAD_URL = 'https://ivc3k5doik.execute-api.us-east-1.amazonaws.com/test/upload';
    const LIST_URL   = 'https://1pzlbysn7b.execute-api.us-east-1.amazonaws.com/test/archivos?limit=5';

    dropZone.addEventListener('dragover',  e => { e.preventDefault(); dropZone.style.borderColor = '#00ccff'; });
    dropZone.addEventListener('dragleave', e => { dropZone.style.borderColor = '#666'; });
    dropZone.addEventListener('drop',     e => {
      e.preventDefault();
      dropZone.style.borderColor = '#666';
      const file = e.dataTransfer.files[0];
      if (file) uploadFileNoCors(file);
    });
    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (file) uploadFileNoCors(file);
    });

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onprogress = event => {
          if (event.lengthComputable) {
            const pct = Math.round((event.loaded / event.total) * 50);
            progressBar.style.width = pct + '%';
          }
        };
        reader.onerror = () => {
          reader.abort();
          reject(new Error('Error al leer el archivo.'));
        };
        reader.onload = () => {
          const base64String = reader.result.split(',')[1];
          resolve(base64String);
        };
        reader.readAsDataURL(file);
      });
    }

    // Opción B: modo no-cors, la respuesta será opaque (status=0),
    // pero al menos no dará “Failed to fetch”
    async function uploadFileNoCors(file) {
      result.style.display = 'none';
      progressBar.style.width = '0%';

      try {
        const base64Body = await fileToBase64(file);
        const payload = {
          filename: file.name,
          body: base64Body,
          isBase64Encoded: true
        };

        await fetch(UPLOAD_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload),
          mode: 'no-cors'
        });

        // Si llegas aquí, el navegador no bloqueó la petición
        progressBar.style.width = '100%';
        result.style.display = 'block';
        result.textContent = `Archivo "${file.name}" subido (no-cors).`;
        loadArchivos(); // Puede que esta GET también necesite no-cors o un proxy

      } catch (err) {
        progressBar.style.width = '0%';
        result.style.display = 'block';
        result.textContent = `Ocurrió un error de red: ${err.message}`;
        console.error(err);
      }
    }

    async function loadArchivos() {
      const tbody = document.getElementById('archivos-tbody');
      tbody.innerHTML = '';

      try {
        const response = await fetch(LIST_URL, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
          mode: 'no-cors'
        });
        // No podrás leer response.json() porque es opaque (mode:no-cors)
        // Si quieres renderizar la tabla, tendrás que usar un proxy aquí también.
      } catch (err) {
        console.error('Error al cargar archivos:', err);
      }
    }

    window.addEventListener('DOMContentLoaded', loadArchivos);
  </script>
</body>

</html>

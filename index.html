<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detector de Voz IA</title>
  <style>
    * {
      box-sizing: border-box;
    }

    main {
      text-align: center;
      padding: 40px 20px;
    }

    main h1 {
      margin-bottom: 40px;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to bottom right, #1f1f1f, #333);
      color: #fff;
      margin: 0;
      padding-top: 80px;
      padding-bottom: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }

    header {
      position: fixed;
      top: 0;
      width: 100%;
      background-color: #121212;
      padding: 20px 0;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    header h2 {
      margin: 0;
      font-size: 1.5em;
      color: #00ccff;
    }

    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background-color: #121212;
      text-align: center;
      padding: 10px 20px;
      font-size: 0.9em;
      color: #aaa;
      border-top: 1px solid #333;
    }

    h1 {
      margin-bottom: 80px;
      font-size: 2em;
    }

    .drop-zone {
      border: 2px dashed #666;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      width: 90%;
      max-width: 500px;
      background-color: #2c2c2c;
      cursor: pointer;
      transition: border-color 0.3s ease;
      margin: 40px auto;
    }

    .drop-zone:hover {
      border-color: #00ccff;
    }

    input[type="file"] {
      display: none;
    }

    .progress-container {
      margin: 60px auto 40px auto;
      width: 100%;
      max-width: 500px;
    }

    .progress-bar {
      height: 20px;
      background-color: #00ccff;
      width: 0%;
      border-radius: 10px;
      transition: width 0.4s ease;
    }

    .result {
      margin-top: 50px;
      font-size: 1.2em;
      padding: 10px 20px;
      background-color: #444;
      border-radius: 10px;
    }

    /* Estilos para la lista de archivos */
    #lista-archivos {
      width: 90%;
      max-width: 800px;
      margin: 40px auto;
      background-color: #2c2c2c;
      border-radius: 10px;
      padding: 20px;
    }

    #lista-archivos h2 {
      margin-bottom: 20px;
      color: #00ccff;
    }

    #archivos-table {
      width: 100%;
      border-collapse: collapse;
    }

    #archivos-table th,
    #archivos-table td {
      padding: 10px;
      border: 1px solid #444;
      text-align: left;
      font-size: 0.9em;
    }

    #archivos-table th {
      background-color: #121212;
      color: #00ccff;
    }

    #archivos-table td a {
      color: #00ccff;
      text-decoration: none;
    }

    #archivos-table td a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>

  <header>
    <h2>Sistema de Detección de Voz IA</h2>
  </header>

  <main>
    <h1>Sube tu archivo de audio</h1>
    <br><br><br>
    <label class="drop-zone" id="drop-zone">
      Arrastra tu archivo de audio aquí o haz clic para subir
      <input type="file" accept="audio/*" id="file-input" />
    </label>

    <div class="progress-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>

    <div class="result" id="result" style="display: none;"></div>

    <!-- Sección para mostrar la lista de archivos -->
    <div id="lista-archivos">
      <h2>Archivos Recientes</h2>
      <table id="archivos-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre de Archivo</th>
            <th>Fecha de Subida</th>
            <th>Enlace S3</th>
          </tr>
        </thead>
        <tbody id="archivos-tbody">
          <!-- Aquí se inyectarán las filas -->
        </tbody>
      </table>
    </div>
  </main>

  <footer>
    Proyecto Integrado de Ingeniería de Software<br>
    Grupo 4: Carlos Fuentes, Ricardo Medina, Genesis Piña y Marcelo Rozas
  </footer>

  <script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const progressBar = document.getElementById('progress-bar');
    const result = document.getElementById('result');

    // Endpoint exacto para subir archivos
    const UPLOAD_URL = 'https://ivc3k5doik.execute-api.us-east-1.amazonaws.com/test/upload';

    // Endpoint para listar archivos (GET)
    const LIST_URL = 'https://1pzlbysn7b.execute-api.us-east-1.amazonaws.com/test/archivos?limit=5';

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#00ccff';
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.style.borderColor = '#666';
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#666';
      const file = e.dataTransfer.files[0];
      if (file) uploadFile(file);
    });

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (file) uploadFile(file);
    });

    /**
     * Convierte un Blob/File a Base64.
     * @param {File} file 
     * @returns {Promise<string>} Cadena Base64 (sin prefijo "data:")
     */
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onprogress = (event) => {
          if (event.lengthComputable) {
            const pct = Math.round((event.loaded / event.total) * 50);
            progressBar.style.width = pct + '%';
          }
        };
        reader.onerror = () => {
          reader.abort();
          reject(new Error('Error al leer el archivo.'));
        };
        reader.onload = () => {
          // reader.result es "data:audio/wav;base64,AAAA..."
          const base64String = reader.result.split(',')[1];
          resolve(base64String);
        };
        reader.readAsDataURL(file);
      });
    }

    /**
     * Sube el archivo al endpoint, codificado en Base64.
     * Si el servidor responde con código 200, se considera éxito.
     * @param {File} file 
     */
    async function uploadFile(file) {
      // Reset de UI
      result.style.display = 'none';
      progressBar.style.width = '0%';

      try {
        // 1) Convertir a Base64
        const base64Body = await fileToBase64(file);
        // Ya tenemos hasta 50% en la barra

        // 2) Construir el JSON para el body
        const payload = {
          filename: file.name,
          body: base64Body,
          isBase64Encoded: true
        };

        // 3) Enviar POST al endpoint con los headers indicados
        const response = await fetch(UPLOAD_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        // 4) Si el status es exactamente 200 → éxito
        console.log(response);
        if (response.status === 200) {
          progressBar.style.width = '100%';
          // Intentamos parsear el JSON, pero aunque falle, ya sabemos que fue 200
          let data = null;
          try {
            data = await response.json();
          } catch (parseErr) {
            console.warn('No se pudo parsear JSON del body, pero el status fue 200');
          }
          // Mostrar mensaje de éxito
          result.style.display = 'block';
          result.textContent = `Archivo "${file.name}" subido correctamente.`;
          // Si backend devolvió un campo "url", mostrar enlace
          if (data && data.url) {
            const link = document.createElement('a');
            link.href = data.url;
            link.textContent = '(Ver en S3)';
            link.target = '_blank';
            result.appendChild(document.createElement('br'));
            result.appendChild(link);
          }
          // Después de confirmar éxito, recargar la lista de archivos
          loadArchivos();

        } else {
          // Cualquier otro código distinto de 200 → error
          progressBar.style.width = '0%';
          const errorText = await response.text();
          result.style.display = 'block';
          result.textContent = `Error al subir: ${response.status} ${response.statusText}`;
          console.error('Respuesta de error:', errorText);
        }

      } catch (err) {
        // Red, CORS u otras excepciones
        progressBar.style.width = '0%';
        result.style.display = 'block';
        result.textContent = `Ocurrió un error: ${err.message}`;
        console.error('Excepción durante la subida:', err);
      }
    }

    /**
     * Obtiene la lista de archivos desde el endpoint y la muestra en la tabla.
     */
    async function loadArchivos() {
      const tbody = document.getElementById('archivos-tbody');
      tbody.innerHTML = ''; // Limpiar filas anteriores

      try {
        const response = await fetch(LIST_URL, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          console.error('Error al obtener lista de archivos:', response.status, response.statusText);
          return;
        }

        const json = await response.json();
        // El campo "body" viene como string JSON, así que lo parseamos:
        const archivos = JSON.parse(json.body);

        if (!Array.isArray(archivos) || archivos.length === 0) {
          const filaVacia = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 4;
          td.style.textAlign = 'center';
          td.textContent = 'No hay archivos recientes.';
          filaVacia.appendChild(td);
          tbody.appendChild(filaVacia);
          return;
        }

        archivos.forEach((item) => {
          const tr = document.createElement('tr');

          // ID
          const tdId = document.createElement('td');
          tdId.textContent = item.id;
          tr.appendChild(tdId);

          // Nombre de archivo
          const tdNombre = document.createElement('td');
          tdNombre.textContent = item.nombre_archivo;
          tr.appendChild(tdNombre);

          // Fecha subida (formateada)
          const tdFecha = document.createElement('td');
          const fechaObj = new Date(item.fecha_subida);
          const fechaLegible = fechaObj.toLocaleString('es-CL', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });
          tdFecha.textContent = fechaLegible;
          tr.appendChild(tdFecha);

          // Enlace S3
          const tdLink = document.createElement('td');
          const enlace = document.createElement('a');
          enlace.href = item.s3_url;
          enlace.textContent = 'Ver/Descargar';
          enlace.target = '_blank';
          tdLink.appendChild(enlace);
          tr.appendChild(tdLink);

          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error('Error al parsear o mostrar la lista de archivos:', err);
      }
    }

    // Al cargar la página, obtenemos y mostramos la lista de archivos
    window.addEventListener('DOMContentLoaded', () => {
      loadArchivos();
    });
  </script>
</body>

</html>
